<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tengo Vinos — Catálogo Premium | Vinos de Mendoza</title>
  <meta name="description" content="Catálogo de vinos premium de Mendoza. Encontrá el vino perfecto para cada ocasión. Envío a domicilio. Consultá por WhatsApp." />
  <meta name="keywords" content="vinos, mendoza, malbec, cabernet, vino tinto, vino blanco, vinos premium" />
  <meta property="og:title" content="Tengo Vinos — Catálogo Premium" />
  <meta property="og:description" content="Catálogo de vinos premium de Mendoza" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://feermoya.github.io/catalogo-vinos/img/logo1.png" />
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700;800&display=swap" rel="stylesheet">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root{
      --bg:#f6f0e8;
      --ink:#2b2b2b;
      --accent:#6b2b2b;
      --muted:#6b6b6b;
      --card:#fff8f0;
      --stroke:#d3c3b2;
    }
    
    *{box-sizing:border-box}
    
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:'Montserrat',system-ui,-apple-system,Roboto,Inter,Ubuntu,Arial,sans-serif;
    }
    
    .wrap{max-width:720px;margin:auto;padding:16px}
    
    header{
      display:flex;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      background:var(--bg);
      padding:10px 0;
      z-index:2;
      flex-wrap:wrap;
    }
    
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    
    .brand img{
      width:44px;
      height:44px;
      border-radius:12px;
      object-fit:cover;
      background:#efe7db;
      border:1px solid #cbbba8;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
    }
    
    h1{
      margin:0;
      font-size:1.25rem;
      color:var(--accent);
      font-weight:800;
    }
    
    .sub{
      font-size:.9rem;
      color:var(--muted);
      font-weight:500;
    }
    
    .toolbar{
      display:flex;
      gap:12px;
      margin:20px 0;
      flex-wrap:wrap;
      padding:0 4px;
      min-width:100%;
    }
    
    .filter-group{
      flex:1;
      min-width:140px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    
    .filter-label{
      font-size:11px;
      font-weight:500;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin:0;
    }
    
    .filter-select{
      background:white;
      border:2px solid #e9ecef;
      border-radius:12px;
      padding:12px 16px;
      font-size:15px;
      font-weight:600;
      color:var(--ink);
      transition:all 0.2s ease;
      appearance:none;
      background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:16px;
      padding-right:40px;
    }
    
    .filter-select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(139, 69, 19, 0.1);
    }
    
    .filter-select:hover{
      border-color:#d1d5db;
    }
    
    @media(min-width:520px){
      .toolbar{min-width:0}
    }
    
    input,select,button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      font-size:1rem;
      font-family:'Montserrat',sans-serif;
      transition:all .15s ease;
    }
    
    input{
      flex:1;
      min-width:130px;
    }
    
    input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(107,43,43,.1);
    }
    
    select{
      cursor:pointer;
      font-weight:500;
    }
    
    select:hover{
      border-color:var(--accent);
    }
    
    button.primary{
      background:var(--accent);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:700;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    
    button.primary:hover:not([disabled]){
      transform:translateY(-2px);
      box-shadow:0 6px 18px rgba(107,43,43,.3);
    }
    
    button.primary:active:not([disabled]){
      transform:translateY(0);
    }
    
    button[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    
    @media(min-width:520px){
      .grid{grid-template-columns:1fr 1fr}
    }
    
    .card{
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      display:flex;
      gap:12px;
      padding:10px;
      border:1px solid #eadfd1;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    
    .card.destacado{
      box-shadow:0 0 25px rgba(107, 43, 43, 0.4), 0 0 15px rgba(107, 43, 43, 0.3), 0 4px 6px rgba(0,0,0,.1);
      border:2px solid var(--accent);
      animation:pulseGlow 2s ease-in-out infinite;
    }
    
    @keyframes pulseGlow{
      0%, 100%{box-shadow:0 0 25px rgba(107, 43, 43, 0.4), 0 0 15px rgba(107, 43, 43, 0.3), 0 4px 6px rgba(0,0,0,.1)}
      50%{box-shadow:0 0 35px rgba(107, 43, 43, 0.5), 0 0 20px rgba(107, 43, 43, 0.4), 0 6px 10px rgba(0,0,0,.15)}
    }
    
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    
    .ph{
      width:110px;
      height:110px;
      background:#efe7db;
      display:grid;
      place-items:center;
      color:var(--accent);
      font-weight:700;
      border-radius:12px;
      overflow:hidden;
    }
    
    .thumb{
      width:110px;
      height:110px;
      object-fit:cover;
      border-radius:12px;
      display:block;
      transition:transform .3s ease, object-fit .3s ease;
      cursor:pointer;
    }
    
    .thumb:hover{
      transform:scale(1.8);
      object-fit:contain;
      z-index:10;
      position:relative;
      box-shadow:0 8px 25px rgba(0,0,0,.3);
    }
    
    .card .body{
      padding:2px 0 0 0;
      flex:1;
      min-width:0;
    }
    
    .name{
      font-weight:700;
      font-size:1rem;
      margin-bottom:4px;
    }
    
    .meta{
      color:var(--muted);
      font-size:.9rem;
      margin-bottom:6px;
    }
    
    .price{
      font-weight:800;
      color:var(--accent);
    }
    
    .qty{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
    }
    
    .qty .count{
      font-weight:700;
      min-width:18px;
      text-align:center;
    }
    
    .iconbtn{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
      transition:transform .1s ease, background .15s ease, border-color .15s ease;
      font-size:1.2rem;
      font-weight:600;
      color:var(--ink);
    }
    
    .iconbtn:active{
      transform:scale(.94);
    }
    
    .iconbtn:hover{
      border-color:var(--accent);
    }
    
    .iconbtn--plus{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    
    .iconbtn--plus:hover{
      background:#5a2424;
    }
    
    .iconbtn--minus{
      background:#fff;
    }
    
    .cartbar{
      position:sticky;
      bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#1f1b18;
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      margin-top:14px;
      box-shadow:0 4px 20px rgba(0,0,0,.2);
      gap:10px;
      flex-wrap:wrap;
    }
    
    .cartbar button{
      transition:transform .15s ease, opacity .15s ease;
    }
    
    .cartbar button:hover:not([disabled]){
      transform:scale(1.05);
    }
    
    .cartbar button:active:not([disabled]){
      transform:scale(.98);
    }
    
    .muted{
      color:var(--muted);
      font-size:.85rem;
      margin-top:6px;
    }

    /* ===== BOTÓN AGREGAR VINO ===== */
    .add-wine-btn{
      background:linear-gradient(135deg, #28a745, #20c997);
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
      font-size:.9rem;
    }
    
    .add-wine-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(40,167,69,.3);
    }

    /* ===== BOTÓN ADMINISTRACIÓN ===== */
    .admin-btn{
      background:linear-gradient(135deg, #6c757d, #495057);
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
      font-size:.9rem;
    }
    
    .admin-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(108,117,125,.3);
    }
    
    /* Instagram Link */
    .social-links{
      margin-top:8px;
    }
    
    .instagram-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#E4405F;
      text-decoration:none;
      font-size:14px;
      font-weight:500;
      padding:6px 12px;
      border:1px solid #E4405F;
      border-radius:20px;
      transition:all .2s ease;
    }
    
    .instagram-link:hover{
      background:#E4405F;
      color:white;
      transform:translateY(-1px);
    }
    
    /* Info Banner */
    .info-banner{
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border:1px solid #dee2e6;
      border-radius:12px;
      margin:20px auto;
      max-width:800px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    
    .info-content{
      padding:20px;
      text-align:center;
    }
    
    .info-content h3{
      margin:0 0 12px 0;
      color:var(--accent);
      font-size:18px;
      font-weight:700;
    }
    
    .info-content p{
      margin:0;
      color:var(--ink);
      font-size:15px;
      line-height:1.5;
    }
    
    /* WhatsApp Button */
    .whatsapp-btn{
      background:linear-gradient(135deg, #25D366 0%, #20BA5A 100%) !important;
      color:white !important;
      border:none !important;
      padding:12px 20px !important;
      border-radius:25px !important;
      font-size:16px !important;
      font-weight:600 !important;
      cursor:pointer;
      transition:all .3s ease !important;
      box-shadow:0 4px 15px rgba(37, 211, 102, 0.3);
      position:relative;
      overflow:hidden;
    }
    
    .whatsapp-btn:hover:not([disabled]){
      transform:translateY(-2px) scale(1.05) !important;
      box-shadow:0 6px 20px rgba(37, 211, 102, 0.4) !important;
    }
    
    .whatsapp-btn:active:not([disabled]){
      transform:translateY(0) scale(1.02) !important;
    }
    
    .whatsapp-btn[disabled]{
      background:#ccc !important;
      color:#666 !important;
      box-shadow:none !important;
      cursor:not-allowed !important;
    }
    
    .whatsapp-btn::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition:left 0.5s;
    }
    
    .whatsapp-btn:hover:not([disabled])::before{
      left:100%;
    }
    
    /* Cart Info */
    .cart-info{
      display:flex;
      align-items:center;
      gap:12px;
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border:1px solid #dee2e6;
      border-radius:12px;
      padding:16px;
      margin:16px auto;
      max-width:600px;
    }
    
    .cart-icon{
      font-size:24px;
      flex-shrink:0;
    }
    
    .cart-text{
      font-size:14px;
      line-height:1.4;
      color:var(--ink);
    }

    /* ===== PANEL DE ADMINISTRACIÓN ===== */
    .admin-modal-content{
      max-width:800px;
      width:95%;
      max-height:90vh;
      overflow-y:auto;
    }
    
    .admin-tabs{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      border-bottom:2px solid #e0e0e0;
    }
    
    .tab-btn{
      background:none;
      border:none;
      padding:12px 20px;
      cursor:pointer;
      font-weight:600;
      color:var(--muted);
      border-bottom:3px solid transparent;
      transition:all .15s ease;
    }
    
    .tab-btn.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }
    
    .tab-btn:hover{
      color:var(--accent);
    }
    
    .admin-tab-content{
      min-height:400px;
    }
    
    .admin-actions{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    
    .btn-primary{
      background:var(--accent);
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
    }
    
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(107,43,43,.3);
    }
    
    .btn-secondary{
      background:#6c757d;
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
    }
    
    .btn-secondary:hover{
      background:#5a6268;
      transform:translateY(-1px);
    }
    
    .wines-list{
      max-height:400px;
      overflow-y:auto;
    }
    
    .wine-item{
      display:flex;
      align-items:center;
      gap:15px;
      padding:15px;
      border:1px solid #e0e0e0;
      border-radius:10px;
      margin-bottom:10px;
      background:#f8f9fa;
    }
    
    .wine-item img{
      width:60px;
      height:60px;
      object-fit:cover;
      border-radius:8px;
    }
    
    .wine-info{
      flex:1;
    }
    
    .wine-name{
      font-weight:700;
      margin-bottom:4px;
    }
    
    .wine-meta{
      color:var(--muted);
      font-size:.9rem;
      margin-bottom:4px;
    }
    
    .wine-price{
      font-weight:700;
      color:var(--accent);
    }
    
    .wine-actions{
      display:flex;
      gap:8px;
    }
    
    .btn-edit{
      background:#17a2b8;
      color:white;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      font-size:.8rem;
      cursor:pointer;
    }
    
    .btn-delete{
      background:#dc3545;
      color:white;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      font-size:.8rem;
      cursor:pointer;
    }
    
    .btn-edit:hover{
      background:#138496;
    }
    
    .btn-delete:hover{
      background:#c82333;
    }

    /* ===== MODAL ===== */
    .modal{
      display:none;
      position:fixed;
      z-index:1000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background-color:rgba(0,0,0,.5);
      backdrop-filter:blur(4px);
    }
    
    .modal-content{
      background:white;
      margin:5% auto;
      padding:0;
      border-radius:20px;
      width:90%;
      max-width:500px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      animation:modalSlideIn .3s ease;
    }
    
    @keyframes modalSlideIn{
      from{opacity:0;transform:translateY(-50px) scale(.9)}
      to{opacity:1;transform:translateY(0) scale(1)}
    }
    
    .modal-header{
      background:linear-gradient(135deg, var(--accent), #8b3a3a);
      color:white;
      padding:20px;
      border-radius:20px 20px 0 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .modal-header h2{
      margin:0;
      font-size:1.3rem;
      font-weight:700;
    }
    
    .close{
      color:white;
      font-size:28px;
      font-weight:bold;
      cursor:pointer;
      transition:opacity .15s ease;
    }
    
    .close:hover{
      opacity:.7;
    }
    
    #wine-form{
      padding:25px;
    }
    
    .form-group{
      margin-bottom:20px;
    }
    
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:15px;
    }
    
    .form-group label{
      display:block;
      margin-bottom:6px;
      font-weight:600;
      color:var(--ink);
      font-size:.9rem;
    }
    
    .form-group input,
    .form-group select{
      width:100%;
      padding:12px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      font-size:1rem;
      font-family:'Montserrat',sans-serif;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(107,43,43,.1);
    }
    
    .form-group small{
      display:block;
      margin-top:4px;
      color:var(--muted);
      font-size:.8rem;
    }
    
    .help-text{
      color:#888;
      font-size:11px;
      font-style:italic;
      margin-top:4px;
      display:block;
    }
    
    .modal-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:25px;
    }
    
    .btn-cancel{
      background:#f8f9fa;
      color:var(--muted);
      border:2px solid #e0e0e0;
      padding:12px 24px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
    }
    
    .btn-cancel:hover{
      background:#e9ecef;
      border-color:#adb5bd;
    }
    
    .btn-save{
      background:linear-gradient(135deg, var(--accent), #8b3a3a);
      color:white;
      border:none;
      padding:12px 24px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
    }
    
    .btn-save:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(107,43,43,.3);
    }

    /* ===== MODAL DE IMAGEN ===== */
    .image-modal-content{
      background:white;
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      max-width:95vw;
      max-height:95vh;
      width:1000px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    
    .wine-detail-container{
      display:flex;
      min-height:500px;
    }
    
    .wine-image-section{
      flex:1;
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px;
    }
    
    .wine-image-section img{
      max-width:100%;
      max-height:400px;
      object-fit:contain;
      border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    
    .wine-info-section{
      flex:1;
      padding:40px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    
    .wine-info-section h2{
      margin:0 0 16px 0;
      color:var(--accent);
      font-size:24px;
      font-weight:700;
      line-height:1.3;
    }
    
    .wine-details-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:20px;
    }
    
    .wine-detail-item{
      background:#f8f9fa;
      padding:12px;
      border-radius:8px;
      border-left:3px solid var(--accent);
    }
    
    .wine-detail-label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      font-weight:600;
      margin-bottom:4px;
    }
    
    .wine-detail-value{
      font-size:14px;
      color:var(--ink);
      font-weight:500;
    }
    
    .wine-description{
      background:linear-gradient(135deg, #fff8f0 0%, #f6f0e8 100%);
      padding:20px;
      border-radius:12px;
      border:1px solid #e9ecef;
      line-height:1.6;
      color:var(--ink);
    }
    
    .wine-description p{
      margin:0 0 16px 0;
    }
    
    .wine-description p:last-child{
      margin-bottom:0;
    }
    
    /* Ocasiones */
    .wine-ocasiones{
      margin-top:20px;
      padding-top:20px;
      border-top:1px solid #e9ecef;
    }
    
    .wine-ocasiones h4{
      margin:0 0 12px 0;
      color:var(--accent);
      font-size:16px;
      font-weight:600;
    }
    
    .ocasiones-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    
    .ocasion-tag{
      background:linear-gradient(135deg, #25D366 0%, #20BA5A 100%);
      color:white;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:500;
      white-space:nowrap;
    }
    
    /* Indicador de stock */
    .stock-badge{
      display:inline-block;
      padding:3px 8px;
      border-radius:8px;
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin-bottom:8px;
    }
    
    .stock-available{
      background:#25D366;
      color:white;
    }
    
    .stock-out{
      background:#FF6B6B;
      color:white;
    }
    
    /* Descuentos */
    .price-container{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin:12px 0;
    }
    
    .discount-badge{
      background:#FF6B6B;
      color:white;
      padding:2px 6px;
      border-radius:4px;
      font-size:9px;
      font-weight:600;
      letter-spacing:0.3px;
      align-self:flex-start;
    }
    
    .price-wrapper{
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .price-current{
      font-size:20px;
      font-weight:700;
      color:var(--accent);
    }
    
    .price-old{
      font-size:14px;
      color:#999;
      text-decoration:line-through;
    }
    
    /* Responsive para móviles */
    @media (max-width: 768px) {
      .wine-detail-container{
        flex-direction:column;
      }
      
      .wine-image-section{
        padding:20px;
        min-height:200px;
      }
      
      .wine-image-section img{
        max-height:200px;
      }
      
      .wine-info-section{
        padding:20px;
      }
      
      .wine-info-section h2{
        font-size:20px;
      }
      
      .wine-details-grid{
        grid-template-columns:1fr;
      }
      
      .image-modal-content{
        width:95vw;
        max-height:90vh;
      }
    }
    
    #close-image{
      position:absolute;
      top:20px;
      right:30px;
      color:white;
      font-size:40px;
      font-weight:bold;
      cursor:pointer;
      z-index:1001;
      text-shadow:0 2px 4px rgba(0,0,0,.5);
    }
    
    #close-image:hover{
      opacity:.8;
    }

    /* ===== CARRITO FLOTANTE ===== */
    .floating-cart{
      position:fixed;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:100;
      opacity:0;
      visibility:hidden;
      transition:all .3s ease;
      cursor:pointer;
    }
    
    .floating-cart.show{
      opacity:1;
      visibility:visible;
    }
    
    .floating-cart-content{
      background:linear-gradient(135deg, var(--accent), #8b3a3a);
      color:white;
      padding:12px 16px;
      border-radius:20px;
      box-shadow:0 8px 25px rgba(107,43,43,.4);
      display:flex;
      align-items:center;
      gap:10px;
      min-width:120px;
      backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,.2);
    }
    
    .floating-cart-icon{
      font-size:1.5rem;
      animation:bounce 2s infinite;
    }
    
    .floating-cart-info{
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    
    .floating-cart-items{
      font-size:1.1rem;
      font-weight:700;
      line-height:1;
    }
    
    .floating-cart-total{
      font-size:.9rem;
      font-weight:600;
      opacity:.9;
    }
    
    @keyframes bounce{
      0%, 20%, 50%, 80%, 100%{transform:translateY(0)}
      40%{transform:translateY(-3px)}
      60%{transform:translateY(-2px)}
    }
    
    @media(max-width:768px){
      .floating-cart{
        right:10px;
        top:auto;
        bottom:100px;
        transform:none;
      }
      
      .floating-cart-content{
        padding:10px 14px;
        min-width:100px;
      }
    }
    
    @media(max-width:600px){
      .modal-content{
        margin:10% auto;
        width:95%;
      }
      
      .form-row{
        grid-template-columns:1fr;
      }
      
      .modal-actions{
        flex-direction:column;
      }
      
      .toolbar{
        flex-direction:column;
        gap:16px;
        margin:16px 0;
      }
      
      .filter-group{
        min-width:100%;
      }
      
      .filter-select{
        font-size:16px; /* Evita zoom en iOS */
        padding:14px 16px;
      }
    }

    /* ===== ANIMACIONES ===== */
    @keyframes bump{
      0%{transform:scale(1)}
      30%{transform:scale(1.14)}
      70%{transform:scale(.96)}
      100%{transform:scale(1)}
    }
    
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(107,43,43,.45)}
      70%{box-shadow:0 0 0 14px rgba(107,43,43,0)}
      100%{box-shadow:0 0 0 0 rgba(107,43,43,0)}
    }
    
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-2px)}
      75%{transform:translateX(2px)}
    }
    
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .anim-bump{
      animation:bump .32s ease;
    }
    
    .anim-pulse{
      animation:pulse .6s ease;
    }
    
    .anim-shake{
      animation:shake .25s ease;
    }
    
    .card{
      animation:fadeIn .4s ease backwards;
    }
    
    .card:nth-child(1){animation-delay:.05s}
    .card:nth-child(2){animation-delay:.1s}
    .card:nth-child(3){animation-delay:.15s}
    .card:nth-child(4){animation-delay:.2s}
    .card:nth-child(5){animation-delay:.25s}
    
    @media (prefers-reduced-motion: reduce){
      .card,.iconbtn,button{transition:none}
      .anim-bump,.anim-pulse,.anim-shake{animation:none}
      .card{animation:none}
    }
  </style>
</head>
<body>
  <!-- Banner informativo de Firebase -->
  <div id="firebase-warning" style="display:none; background:#ff6b6b; color:white; padding:15px; text-align:center; font-weight:bold;">
    ⚠️ Firebase no configurado. Los cambios no se guardarán en la web. Lee <a href="CONFIGURAR-FIREBASE.md" style="color:white; text-decoration:underline;" target="_blank">CONFIGURAR-FIREBASE.md</a>
  </div>
  
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="img/logo1.png" alt="Tengo Vinos Logo" />
        <div>
      <h1>Tengo Vinos</h1>
          <div class="sub">Catálogo Premium</div>
          <div class="social-links">
            <a href="https://www.instagram.com/tengovinos/" target="_blank" class="instagram-link">
              📸 @tengovinos
            </a>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <div class="filter-group">
          <label for="ocasion" class="filter-label">Filtrar por ocasión</label>
          <select id="ocasion" class="filter-select">
            <option value="">Todas las ocasiones</option>
            <option value="Cena especial">💕 Cena especial</option>
            <option value="Asado">🥩 Asado</option>
            <option value="Almuerzo">🍽️ Almuerzo</option>
            <option value="Aperitivo">🥂 Aperitivo</option>
            <option value="Regalo">🎁 Regalo</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="order" class="filter-label">Ordenar por</label>
          <select id="order" class="filter-select">
            <option value="name-asc">Nombre A→Z</option>
            <option value="name-desc">Nombre Z→A</option>
            <option value="price-asc">Precio ↑</option>
            <option value="price-desc">Precio ↓</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Mensaje explicativo -->
    <div class="info-banner">
      <div class="info-content">
        <h3>🍷 ¿Cómo funciona?</h3>
        <p>Elegí los vinos que te gusten, ajustá las cantidades y hacé clic en <strong>"Enviar por WhatsApp"</strong>. Te redirigimos a WhatsApp con tu pedido listo para enviar. <strong>¡Es súper fácil!</strong></p>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div class="cartbar">
      <div><strong id="cart-total">$0</strong> <span id="cart-items">(0)</span></div>
      <div>
        <button id="admin-panel" class="admin-btn" style="display:none;">⚙️ Admin</button>
        <button id="add-wine" class="add-wine-btn" style="display:none;">+ Agregar Vino</button>
        <button id="clear" disabled>Vaciar</button>
        <button class="whatsapp-btn" id="whatsapp" disabled>📱 Enviar por WhatsApp</button>
      </div>
    </div>
    <div class="cart-info">
      <div class="cart-icon">🛒</div>
      <div class="cart-text">
        <strong>¡Fácil y rápido!</strong><br>
        Elegí tus vinos, ajustá las cantidades y enviá el pedido por WhatsApp
      </div>
    </div>
  </div>

  <!-- Carrito Flotante -->
  <div id="floating-cart" class="floating-cart" onclick="scrollToCart()">
    <div class="floating-cart-content">
      <div class="floating-cart-icon">🛒</div>
      <div class="floating-cart-info">
        <div class="floating-cart-items">0</div>
        <div class="floating-cart-total">$0</div>
      </div>
    </div>
  </div>

  <!-- Modal para imagen del vino -->
  <div id="image-modal" class="modal">
    <div class="modal-content image-modal-content">
      <span class="close" id="close-image">&times;</span>
      <div class="wine-detail-container">
        <div class="wine-image-section">
          <img id="modal-image" src="" alt="Imagen del vino" />
        </div>
        <div class="wine-info-section">
          <h2 id="modal-wine-name"></h2>
          <div id="modal-wine-details"></div>
          <div id="modal-wine-description"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Administración -->
  <div id="admin-modal" class="modal">
    <div class="modal-content admin-modal-content">
      <div class="modal-header">
        <h2>⚙️ Panel de Administración</h2>
        <span class="close" id="close-admin">&times;</span>
      </div>
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showAdminTab('wines')">🍷 Vinos</button>
        <button class="tab-btn" onclick="showAdminTab('settings')">⚙️ Configuración</button>
      </div>
      
      <!-- Tab de Vinos -->
      <div id="admin-wines" class="admin-tab-content">
        <div class="admin-actions">
          <button class="btn-primary" onclick="openAddWineModal()">+ Agregar Vino</button>
          <button class="btn-secondary" onclick="exportWines()">📤 Exportar</button>
          <button class="btn-secondary" onclick="importWines()">📥 Importar</button>
          <button class="btn-secondary" onclick="resetToDefaults()" style="background:#e74c3c;">🔄 Restaurar Originales</button>
        </div>
        <div id="wines-list" class="wines-list">
          <!-- Lista de vinos se genera dinámicamente -->
        </div>
      </div>
      
      <!-- Tab de Configuración -->
      <div id="admin-settings" class="admin-tab-content" style="display:none;">
        <div class="form-group">
          <label for="admin-whatsapp">Número de WhatsApp</label>
          <input type="text" id="admin-whatsapp" placeholder="5492615760276">
        </div>
        <div class="form-group">
          <label for="admin-title">Título del Catálogo</label>
          <input type="text" id="admin-title" placeholder="Tengo Vinos">
        </div>
        <div class="form-group">
          <label for="admin-subtitle">Subtítulo</label>
          <input type="text" id="admin-subtitle" placeholder="Catálogo Premium">
        </div>
        <div class="admin-actions">
          <button class="btn-primary" onclick="saveSettings()">💾 Guardar Configuración</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para agregar/editar vino -->
  <div id="wine-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>🍷 Agregar Nuevo Vino</h2>
        <span class="close" id="close-wine-modal">&times;</span>
      </div>
      <form id="wine-form">
        <div class="form-group">
          <label for="wine-name">Nombre del Vino *</label>
          <input type="text" id="wine-name" required placeholder="Ej: Malbec Reserva 2023">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="wine-bodega">Bodega *</label>
            <input type="text" id="wine-bodega" required placeholder="Ej: Budeguer">
          </div>
          <div class="form-group">
            <label for="wine-variedad">Variedad *</label>
            <input type="text" id="wine-variedad" required placeholder="Ej: Malbec">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="wine-ml">Mililitros</label>
            <select id="wine-ml">
              <option value="375">375 ml</option>
              <option value="750" selected>750 ml</option>
              <option value="1000">1 L</option>
              <option value="1500">1.5 L</option>
            </select>
          </div>
          <div class="form-group">
            <label for="wine-precio">Precio Actual (ARS) *</label>
            <input type="number" id="wine-precio" required placeholder="8000" min="0">
          </div>
          
          <div class="form-group">
            <label for="wine-precio-anterior">Precio Anterior (ARS)</label>
            <input type="number" id="wine-precio-anterior" placeholder="9500" min="0">
            <small class="help-text">Opcional - para mostrar descuento</small>
          </div>
          
          <div class="form-group">
            <label for="wine-stock">Stock (cantidad de botellas)</label>
            <input type="number" id="wine-stock" placeholder="10" min="0" value="10">
            <small class="help-text">Cantidad disponible. Se resta automáticamente al agregar al carrito.</small>
          </div>
        </div>
        
        <div class="form-group">
          <label for="wine-foto">URL de la Imagen (opcional)</label>
          <input type="url" id="wine-foto" placeholder="https://ejemplo.com/imagen.jpg">
          <small>Pega aquí la URL de la imagen del vino</small>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancel-wine">Cancelar</button>
          <button type="submit" class="btn-save">💾 Guardar Vino</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== CONFIGURACIÓN DE FIREBASE =====
    // IMPORTANTE: Reemplaza esto con tu propia configuración de Firebase
    // Ve a: https://console.firebase.google.com/
    var firebaseConfig = {
      apiKey: "AIzaSyDbb33vUlM75YEndsNYtYprH2Evqlmn77s",
      authDomain: "catalogo-vinos-27f05.firebaseapp.com",
      databaseURL: "https://catalogo-vinos-27f05-default-rtdb.firebaseio.com",
      projectId: "catalogo-vinos-27f05",
      storageBucket: "catalogo-vinos-27f05.firebasestorage.app",
      messagingSenderId: "944813386819",
      appId: "1:944813386819:web:b22c9d4eb5094e87c7b8f6"
    };
    
    // Inicializar Firebase solo si está configurado
    var useFirebase = firebaseConfig.apiKey !== "TU_API_KEY_AQUI";
    var database = null;
    
    if(useFirebase){
      try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log('✅ Firebase conectado');
      } catch(e){
        console.warn('⚠️ No se pudo conectar a Firebase, usando datos locales:', e.message);
        useFirebase = false;
        // No mostrar banner si solo es error de conexión
      }
    } else {
      console.log('ℹ️ Firebase no configurado, usando datos locales');
      // Mostrar banner de advertencia
      document.getElementById('firebase-warning').style.display = 'block';
    }
    
    // CATÁLOGO ACTUALIZADO - Edita precios y productos aquí
    var WHATSAPP_PHONE = "5492615760276";
    var PRODUCTOS = [
      // COMBO DEL MES ⭐
      {id:"0", nombre:"🔥 Combo del Mes", bodega:"Selección", variedad:"Mix", ml:1500, precio:35000, foto:"https://feermoya.github.io/catalogo-vinos/img/41D3FB9F-977C-4921-97A0-C26DB67AF0F1_1_105_c.jpeg", descripcion:"<p><strong>🔥 Combo especial del mes</strong></p>", ocasiones:["Regalo"], destacado:true},
      
      // PREMIUM (más de $15000)
      {id:"1", nombre:"Wayra Vineyard Selection Calyptra", bodega:"Wayra", variedad:"Cabernet Franc", ml:750, precio:20000, precioAnterior:23000, foto:"https://solyvinomendoza.com/36225-superlarge_default_2x/vino-cabernet-franc-calyptra-wayra-single-vineyard-750-ml.jpg", descripcion:"<p><strong>Vino intenso y elegante</strong>, con notas especiadas y final suave. Ideal para disfrutar en una cena especial o para regalar.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"2", nombre:"Tucumén Malbec Bag in Box 3 Litros", bodega:"Budeguer", variedad:"Malbec", ml:3000, precio:18000, precioAnterior:19500, foto:"https://vinerialamision.com.ar/wp-content/uploads/2022/03/47E8F5AE-6945-4B88-BF8E-32F41670EE10-1200x1200.jpeg", stock:1, descripcion:"<p><strong>Malbec fácil de tomar y rendidor.</strong> Perfecto para asados, comidas familiares o juntadas con amigos.</p>", ocasiones:["Asado", "Almuerzo"]},
      {id:"3", nombre:"Budeguer 4000 Gran Reserva Black Blend", bodega:"Budeguer", variedad:"Black Blend", ml:750, precio:18000, precioAnterior:19500, foto:"https://tienda.bodegabudeguer.com/cdn/shop/files/4000_blend_para_web_Mesa_de_trabajo_1_copia_3_2048x2048_crop_center@2x.png?v=1747929746", descripcion:"<p><strong>Blend potente y elegante</strong> de Malbec, Cabernet Sauvignon y Petit Verdot. Vino de guarda, ideal para carnes rojas, platos elaborados o una cena especial.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"4", nombre:"Mairena Reserva Familia Blanco Bonarda", bodega:"Mairena", variedad:"Bonarda", ml:750, precio:17000, precioAnterior:19500, foto:"https://solyvinomendoza.com/36142-superlarge_default_2x/vino-bonarda-mairena-reserva-750-ml.jpg", descripcion:"<p><strong>Tinto con cuerpo</strong> y toques frutales. Acompaña bien carnes grilladas o pastas con salsa roja.</p>", ocasiones:["Asado", "Cena especial"]},
      {id:"5", nombre:"Mairena Reserva Familia Blanco Blend", bodega:"Mairena", variedad:"Blend", ml:750, precio:16500, precioAnterior:18000, foto:"https://solyvinomendoza.com/36142-superlarge_default_2x/vino-bonarda-mairena-reserva-750-ml.jpg", descripcion:"<p><strong>Blend de Malbec, Bonarda y Cabernet</strong> con cuerpo y notas frutales y especiadas. Ideal para cenas importantes o para regalar.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"6", nombre:"Prisma Penedo Borges Chardonnay 2023", bodega:"Penedo Borges", variedad:"Chardonnay", ml:750, precio:16500, foto:"https://tienda.penedoborges.com.ar/cdn/shop/products/PRISMA-CH_1000x.jpg?v=1715141378", descripcion:"<p><strong>Chardonnay fresco y elegante</strong>, con notas cítricas y florales. Ideal para pescados, mariscos o aperitivos.</p>", ocasiones:["Almuerzo", "Aperitivo"]},
      {id:"7", nombre:"Prisma Penedo Borges Gran Malbec 2022", bodega:"Penedo Borges", variedad:"Malbec", ml:750, precio:16500, foto:"https://solyvinomendoza.com/36057-superlarge_default_2x/vino-malbec-penedo-borges-prisma-gran-reserva-750-ml.jpg", descripcion:"<p><strong>Malbec potente y redondo</strong>, pensado para carnes al horno o parrilla. Ideal para una noche especial o regalar.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"8", nombre:"Luna Llena Finca Ambrosia Gran Malbec 2023", bodega:"Luna Llena", variedad:"Malbec", ml:750, precio:15500, foto:"https://solyvinomendoza.com/6364-superlarge_default_2x/vino-malbec-ambrosia-luna-llena-malbec-750-ml.jpg", descripcion:"<p><strong>Gran Malbec elegante</strong>, con notas de frutas maduras y madera suave. Ideal para cenas importantes o para regalar.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"9", nombre:"El Turco Alto Cedro Malbec", bodega:"Alto Cedro", variedad:"Malbec", ml:750, precio:15500, foto:"https://vinotecaligier.com/media/catalog/product/cache/73269a27812eefec516431430aa0b457/b/e/be76608_base.jpg", descripcion:"<p><strong>Malbec joven y expresivo</strong>, con buena frescura. Perfecto para asados, pastas o comidas del mediodía.</p>", ocasiones:["Asado", "Almuerzo"]},
      
      // GAMA MEDIA ($10000 - $15000)
      {id:"10", nombre:"Cepas Penedo Borges Malbec", bodega:"Penedo Borges", variedad:"Malbec", ml:750, precio:12900, foto:"https://solyvinomendoza.com/36425-superlarge_default_2x/vino-cabernet-sauvignon-penedo-borges-cepas-750-ml.jpg", descripcion:"<p><strong>Malbec equilibrado</strong>, con notas a ciruela y vainilla. Ideal para carnes rojas o una cena tranquila.</p>", ocasiones:["Asado", "Cena especial"]},
      {id:"11", nombre:"Las Nencias Reserva Cabernet Sauvignon", bodega:"Las Nencias", variedad:"Cabernet Sauvignon", ml:750, precio:11000, foto:"https://acdn-us.mitiendanube.com/stores/005/747/302/products/diseno-sin-titulo-8-1853f8c7b9b4a8676317388789472350-1024-1024.png", descripcion:"<p><strong>Cabernet con cuerpo</strong>, taninos firmes y aroma a pimienta. Ideal para carnes grilladas o cenas elegantes.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"12", nombre:"Budeguer 4000 Reserva 2023 Merlot", bodega:"Budeguer", variedad:"Merlot", ml:750, precio:10000, foto:"https://tienda.bodegabudeguer.com/cdn/shop/products/ProductosEcommerceMesadetrabajo36_1200x1200.png?v=1664369912", descripcion:"<p><strong>Merlot suave y redondo</strong>, con notas a frutas rojas y especias. Perfecto para pastas, carnes blancas o cenas especiales.</p>", ocasiones:["Cena especial", "Almuerzo"]},
      
      // ACCESIBLES (menos de $10000)
      {id:"13", nombre:"Budeguer Tucumén Reserva Petit Verdot", bodega:"Budeguer", variedad:"Petit Verdot", ml:750, precio:9500, foto:"https://vigilwineclub.com/images/product_image/1871/0?fit=fill&w=1024&h=512", descripcion:"<p><strong>Vino intenso y especiado</strong>, con buena estructura. Perfecto para carnes rojas o cenas con platos sabrosos.</p>", ocasiones:["Cena especial", "Asado"]},
      {id:"14", nombre:"La Azul Sauvignon Blanc", bodega:"La Azul", variedad:"Sauvignon Blanc", ml:750, precio:9100, precioAnterior:10500, foto:"https://solyvinomendoza.com/14463-superlarge_default_2x/vino-sauvignon-blanc-la-azul-750-ml.jpg", descripcion:"<p><strong>Blanco fresco y aromático</strong>, con notas cítricas y herbales. Ideal para aperitivos, ensaladas o pescados.</p>", ocasiones:["Aperitivo", "Almuerzo"]},
      {id:"15", nombre:"Mad Bird Malbec 2020", bodega:"Mad Bird", variedad:"Malbec", ml:750, precio:8600, foto:"https://almadelosandes.com.ar/wp-content/uploads/2023/09/DARK-MALBEC.jpg", stock:0, descripcion:"<p><strong>Malbec joven y frutal</strong>, fácil de tomar. Ideal para asados, pizzas o comidas informales.</p>", ocasiones:["Asado", "Almuerzo"]},
      {id:"16", nombre:"Las Perdices Malbec", bodega:"Las Perdices", variedad:"Malbec", ml:750, precio:8500, foto:"https://www.espaciovino.com.ar/media/default/0001/70/thumb_69091_default_big.jpeg", descripcion:"<p><strong>Malbec clásico</strong>, con equilibrio entre fruta y madera. Perfecto para carnes, pastas o comidas en pareja.</p>", ocasiones:["Asado", "Cena especial"]},
      {id:"17", nombre:"La Azul Malbec", bodega:"La Azul", variedad:"Malbec", ml:750, precio:7800, foto:"https://solyvinomendoza.com/14457-superlarge_default_2x/vino-malbec-la-azul-750-ml.jpg", descripcion:"<p><strong>Tinto suave y amable</strong>, con notas frutales. Ideal para acompañar parrillas, pastas o picadas.</p>", ocasiones:["Asado", "Almuerzo"]},
      {id:"18", nombre:"Budeguer Tucumén Reserva Malbec", bodega:"Budeguer", variedad:"Malbec", ml:750, precio:7500, foto:"https://vigilwineclub.com/images/product_image/1871/0?fit=fill&w=1024&h=512", descripcion:"<p><strong>Malbec con paso por barrica</strong>, de cuerpo medio y notas a ciruela y vainilla. Ideal para carnes al horno o asado.</p>", ocasiones:["Cena especial", "Asado"]},
      {id:"19", nombre:"Filo Sur Malbec", bodega:"Filo Sur", variedad:"Malbec", ml:750, precio:7000, foto:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTxNUgVswzOzlyqpHDP6n5jq1_bcuF8h6GgSw&s", descripcion:"<p><strong>Malbec joven, fresco y frutal.</strong> Perfecto para picadas, comidas livianas o almuerzos al aire libre.</p>", ocasiones:["Almuerzo", "Aperitivo"]},
      {id:"20", nombre:"Don Bosco Reserva Malbec", bodega:"Don Bosco", variedad:"Malbec", ml:750, precio:6000, foto:"https://d22fxaf9t8d39k.cloudfront.net/ba9dd59fbe3dbcac3820232ffa4708e5b31b78b55e5f8d475e231c73e8c1bcdd89639.jpeg", descripcion:"<p><strong>Malbec con crianza en roble</strong>, buena estructura y final largo. Ideal para cenas elegantes o como regalo.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"21", nombre:"Cuatro Monos Locos Malbec", bodega:"Cuatro Monos Locos", variedad:"Malbec", ml:750, precio:6000, foto:"https://www.alfonsadistribuidora.com.ar/database/articulo/fotos/5009/VINO%20CUATRO%20MONOS%20LOCOS%20MALBEC%20750CC__1.jpg", descripcion:"<p><strong>Malbec expresivo y frutal</strong>, de cuerpo medio. Ideal para parrilladas o comidas informales entre amigos.</p>", ocasiones:["Asado", "Almuerzo"]},
      {id:"22", nombre:"Desdén Malbec Reserva", bodega:"Desdén", variedad:"Malbec", ml:750, precio:5500, foto:"https://solyvinomendoza.com/36965-superlarge_default_2x/vino-malbec-reserva-desden-750-ml.jpg", descripcion:"<p><strong>Malbec Reserva potente</strong>, con notas a frutas maduras y toques de madera. Perfecto para cenas importantes o regalar.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"23", nombre:"Prófugo Casa La Primavera Chenin Dulce", bodega:"Casa La Primavera", variedad:"Chenin (Dulce)", ml:750, precio:5400, foto:"https://www.espaciovino.com.ar/media/default/0001/71/thumb_70638_default_big.jpeg", descripcion:"<p><strong>Blanco dulce, suave y aromático</strong>, con notas a miel y flores. Ideal para postres, aperitivos o regalar.</p>", ocasiones:["Aperitivo", "Regalo"]},
      {id:"24", nombre:"Sensei Malbec Ahumado", bodega:"Sensei", variedad:"Malbec", ml:750, precio:5300, precioAnterior:6800, foto:"https://www.espaciovino.com.ar/media/default/0001/67/thumb_66447_default_big.jpeg", descripcion:"<p><strong>Malbec único con notas ahumadas.</strong> Perfecto para quienes buscan un vino con personalidad marcada y sabores intensos.</p>", ocasiones:["Cena especial", "Regalo"]},
      {id:"25", nombre:"Corbeau Wines Pixels Malbec", bodega:"Corbeau Wines", variedad:"Malbec", ml:750, precio:5200, foto:"https://dcdn-us.mitiendanube.com/stores/001/725/516/products/whatsapp-image-2023-05-04-at-11-30-101-4cd4a3c245ad1e464216832110653877-640-0.jpeg", descripcion:"<p><strong>Malbec joven, fresco y frutal.</strong> Perfecto para acompañar carnes, empanadas o picadas con amigos.</p>", ocasiones:["Almuerzo", "Asado"]}
    ];

    // ===== FUNCIONES DE PERSISTENCIA CON FIREBASE =====
    
    // Cargar productos desde Firebase o usar los por defecto
    function loadProductos(callback){
      if(!useFirebase){
        callback(PRODUCTOS);
        return;
      }
      
      // COMBINAR: Firebase + Código Local (mejor de ambos)
      database.ref('productos').once('value').then(function(snapshot){
        var data = snapshot.val();
        if(data && Array.isArray(data) && data.length > 0){
          console.log('✅ Combinando datos de Firebase + Código Local');
          // Fusionar inteligentemente
          var productosCombinados = PRODUCTOS.map(function(localProduct){
            var firebaseProduct = data.find(function(fp){ return fp && fp.id === localProduct.id; });
            if(firebaseProduct){
              return {
                ...localProduct, // Base: código local (nombres, descripciones, ocasiones)
                foto: localProduct.foto || firebaseProduct.foto, // PRIORIDAD A CÓDIGO LOCAL (para actualizar fotos)
                stock: firebaseProduct.stock !== undefined ? firebaseProduct.stock : localProduct.stock,
                precio: firebaseProduct.precio || localProduct.precio,
                precioAnterior: firebaseProduct.precioAnterior || localProduct.precioAnterior
              };
            }
            return localProduct; // Si no está en Firebase, usar local
          });
          
          callback(productosCombinados);
        } else {
          console.log('⚠️ Firebase vacío, guardando datos locales');
          saveProductos();
          callback(PRODUCTOS);
        }
      }).catch(function(e){
        console.warn('⚠️ Error al cargar desde Firebase:', e.message);
        callback(PRODUCTOS);
      });
    }
    
    // Guardar productos en Firebase
    function saveProductos(){
      if(!useFirebase){
        console.log('ℹ️ Firebase no configurado, datos no guardados');
        return;
      }
      
      // Limpiar valores undefined antes de guardar
      var productosLimpios = PRODUCTOS.map(function(producto){
        var limpio = {};
        for(var key in producto){
          if(producto[key] !== undefined){
            limpio[key] = producto[key];
          }
        }
        return limpio;
      });
      
      database.ref('productos').set(productosLimpios).then(function(){
        console.log('✅ Productos guardados en Firebase');
      }).catch(function(e){
        console.error('❌ Error al guardar productos en Firebase:', e);
      });
    }
    
    // Cargar configuración desde Firebase
    function loadConfig(){
      if(!useFirebase){
        return;
      }
      
      database.ref('config').once('value').then(function(snapshot){
        var config = snapshot.val();
        if(config){
          if(config.phone) WHATSAPP_PHONE = config.phone;
          if(config.title) document.querySelector('h1').textContent = config.title;
          if(config.subtitle) document.querySelector('.sub').textContent = config.subtitle;
          console.log('✅ Configuración cargada desde Firebase');
        }
      }).catch(function(e){
        console.error('❌ Error al cargar configuración desde Firebase:', e);
      });
    }
    
    // Guardar configuración en Firebase
    function saveConfig(){
      if(!useFirebase){
        console.log('ℹ️ Firebase no configurado, configuración no guardada');
        return;
      }
      
      var config = {
        phone: WHATSAPP_PHONE,
        title: document.querySelector('h1').textContent,
        subtitle: document.querySelector('.sub').textContent
      };
      
      database.ref('config').set(config).then(function(){
        console.log('✅ Configuración guardada en Firebase');
      }).catch(function(e){
        console.error('❌ Error al guardar configuración en Firebase:', e);
      });
    }

    // Cargar carrito desde localStorage
    var savedCart = localStorage.getItem('cart');
    var initialCart = savedCart ? JSON.parse(savedCart) : {};
    
    var state = { rows: PRODUCTOS.slice(), filtered: PRODUCTOS.slice(), cart: initialCart };
    function money(n){ return n.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}); }

    function render(){
      var grid = document.getElementById('grid');
      var html = '';
      for(var i=0;i<state.filtered.length;i++){
        var r = state.filtered[i];
        // Verificar stock considerando lo que ya está en el carrito
        var cantidadEnCarrito = state.cart[r.id] || 0;
        var stockDisponible = r.stock !== undefined ? r.stock - cantidadEnCarrito : 999;
        var stockStatus = (r.stock !== undefined && stockDisponible <= 0) ? '<div class="stock-badge stock-out">Sin stock</div>' : '';
        
        // Calcular descuento si existe precio anterior
        var priceHTML = '';
        if(r.precioAnterior && r.precioAnterior > r.precio){
          priceHTML = "<div class='price-wrapper'>"+
            "<span class='price-current'>"+money(r.precio)+"</span>"+
            "<span class='price-old'>"+money(r.precioAnterior)+"</span>"+
          "</div>";
        } else {
          priceHTML = "<div class='price'>"+money(r.precio)+"</div>";
        }
        
        var isOutOfStock = (r.stock !== undefined && stockDisponible <= 0);
        var disabledBtn = isOutOfStock ? " disabled style='opacity:0.5; cursor:not-allowed;'" : "";
        var cardClass = r.destacado ? "card destacado" : "card";
        
        html += "<div class='"+cardClass+"'>"+
          (r.foto? ("<img class='thumb' src='"+r.foto+"' alt='"+r.nombre+"' onclick='openImageModal(\""+r.foto+"\", \""+r.nombre+"\")'/>") : "<div class='ph'>🍷</div>")+
          "<div class='body'>"+
            stockStatus+
            "<div class='name'>"+r.nombre+"</div>"+
            (r.destacado ? "" : "<div class='meta'>"+r.bodega+" · "+r.variedad+" · "+r.ml+" ml</div>")+
            (r.destacado ? "" : priceHTML)+
            (r.destacado ? "<div style='text-align:center; padding:10px; color:var(--accent); font-weight:600;'>Consultá por WhatsApp 📲</div>" : 
            "<div class='qty'>"+
                "<button class='iconbtn iconbtn--minus' onclick=\"sub('"+r.id+"')\">−</button>"+
                "<span class='count'>"+(state.cart[r.id]||0)+"</span>"+
                "<button class='iconbtn iconbtn--plus' onclick=\"add('"+r.id+"')\""+disabledBtn+">+</button>"+
              "</div>")+
          "</div>"+
        "</div>";
      }
      grid.innerHTML = html;
      renderCart();
    }

    function add(id){ 
      var p = PRODUCTOS.find(x => x.id == id);
      if(!p) return;
      
      // Verificar si hay stock disponible (considerando lo que ya está en el carrito)
      var cantidadActual = state.cart[id] || 0;
      var cantidadTotal = cantidadActual + 1;
      
      if(p.stock !== undefined && cantidadTotal > p.stock){
        return; // No hay suficiente stock
      }
      
      state.cart[id] = (state.cart[id]||0) + 1; 
      
      // Guardar carrito en localStorage
      localStorage.setItem('cart', JSON.stringify(state.cart));
      
      // NO restar stock aquí - solo se resta cuando se confirma la compra
      // El stock se verifica al cargar la página
      
      updateCartDisplay(id); // Solo actualizar el contador específico
      renderCart();
      
      // Re-renderizar para actualizar badges de stock
      render();
      // Animar el botón de WhatsApp
      var btn = document.getElementById('whatsapp');
      btn.classList.remove('anim-pulse');
      setTimeout(function(){ btn.classList.add('anim-pulse'); }, 10);
    }
    
    function sub(id){ 
      if(state.cart[id]){ 
        var p = PRODUCTOS.find(x => x.id == id);
        
        state.cart[id] = Math.max(0, state.cart[id]-1); 
        if(!state.cart[id]) delete state.cart[id]; 
        
        // Guardar carrito en localStorage
        localStorage.setItem('cart', JSON.stringify(state.cart));
        
        // NO devolver stock aquí - el stock solo se modifica al confirmar compra
        
        updateCartDisplay(id); // Solo actualizar el contador específico
        renderCart();
        
        // Re-renderizar para actualizar badges de stock
        render();
      } 
    }

    // Función para actualizar solo el contador de un producto específico
    function updateCartDisplay(productId){
      var countElement = document.querySelector('[onclick="sub(\''+productId+'\')"]').parentElement.querySelector('.count');
      if(countElement){
        countElement.textContent = state.cart[productId] || 0;
      }
    }

    function renderCart(){
      var total=0, items=0;
      for(var pid in state.cart){
        var q = state.cart[pid];
        var r = null;
        for(var i=0;i<state.rows.length;i++){ if(state.rows[i].id===pid){ r=state.rows[i]; break; } }
        if(!r) continue; total += q * r.precio; items += q;
      }
      document.getElementById('cart-total').textContent = money(total);
      document.getElementById('cart-items').textContent = '('+items+')';
      var hasItems = items>0;
      document.getElementById('whatsapp').disabled = !hasItems;
      document.getElementById('clear').disabled = !hasItems;
      
      // Actualizar carrito flotante
      updateFloatingCart();
    }

    // Función para actualizar el carrito flotante
    function updateFloatingCart(){
      var floatingCart = document.getElementById('floating-cart');
      var floatingItems = document.querySelector('.floating-cart-items');
      var floatingTotal = document.querySelector('.floating-cart-total');
      
      var total=0, items=0;
      for(var pid in state.cart){
        var q = state.cart[pid];
        var r = null;
        for(var i=0;i<state.rows.length;i++){ 
          if(state.rows[i].id===pid){ r=state.rows[i]; break; } 
        }
        if(!r) continue; 
        total += q * r.precio; 
        items += q;
      }
      
      if(items > 0){
        floatingItems.textContent = items;
        floatingTotal.textContent = money(total);
        floatingCart.classList.add('show');
      } else {
        floatingCart.classList.remove('show');
      }
    }

    // Función para hacer scroll al carrito principal
    function scrollToCart(){
      var cartbar = document.querySelector('.cartbar');
      cartbar.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Destacar el carrito por un momento
      cartbar.style.background = 'linear-gradient(135deg, #8b3a3a, var(--accent))';
      setTimeout(function(){
        cartbar.style.background = '#1f1b18';
      }, 1000);
    }

    function buildWhatsAppText(){
      var lines=['Hola! Quiero pedir estos vinos:',''];
      var total=0;
      for(var pid in state.cart){
        var q = state.cart[pid];
        var r=null; for(var i=0;i<state.rows.length;i++){ if(state.rows[i].id===pid){ r=state.rows[i]; break; } }
        if(!r) continue; total += q*r.precio; lines.push('• '+r.nombre+' x'+q+' — '+money(r.precio));
      }
      lines.push('');
      lines.push('Total: '+money(total));
      return lines.join('\n'); // <- línea segura y válida
    }

    function sendWhatsApp(){
      // Evitar navegación con carrito vacío
      var empty = true; for(var k in state.cart){ empty=false; break; }
      if(empty) return;
      
      // Restar stock de los productos cuando se confirma la compra
      for(var productId in state.cart){
        var cantidad = state.cart[productId];
        var producto = PRODUCTOS.find(p => p.id == productId);
        
        if(producto && producto.stock !== undefined){
          producto.stock = Math.max(0, producto.stock - cantidad);
        }
      }
      
      // Guardar stock actualizado en Firebase
      if(useFirebase){
        saveProductos();
      }
      
      // Construir texto de WhatsApp ANTES de limpiar carrito
      var text = buildWhatsAppText();
      
      // Limpiar carrito después de construir el texto
      state.cart = {};
      localStorage.removeItem('cart');
      
      // Abrimos WhatsApp en la misma pestaña para evitar bloqueo de popups
      location.href = 'https://wa.me/'+WHATSAPP_PHONE+'?text='+encodeURIComponent(text);
    }

    function applyFilters(){
      var order = document.getElementById('order').value;
      var ocasion = document.getElementById('ocasion').value;
      var arr = [];
      for(var i=0;i<state.rows.length;i++){
        var r = state.rows[i];
        var matchesOcasion = !ocasion || (r.ocasiones && r.ocasiones.includes(ocasion));
        
        if(matchesOcasion) arr.push(r);
      }
      if(order==='name-asc') arr.sort(function(a,b){ return a.nombre.localeCompare(b.nombre); });
      if(order==='price-asc') arr.sort(function(a,b){ return a.precio-b.precio; });
      if(order==='price-desc') arr.sort(function(a,b){ return b.precio-a.precio; });
      state.filtered = arr; render();
    }

    document.getElementById('whatsapp').addEventListener('click',function(){
      var btn = this;
      btn.classList.add('anim-bump');
      setTimeout(function(){ btn.classList.remove('anim-bump'); }, 320);
      sendWhatsApp();
    });
    
    document.getElementById('clear').addEventListener('click',function(){ 
      var btn = this;
      btn.classList.add('anim-shake');
      setTimeout(function(){ btn.classList.remove('anim-shake'); }, 250);
      state.cart={}; 
      render(); 
    });
    
    document.getElementById('order').addEventListener('change',applyFilters);
    document.getElementById('ocasion').addEventListener('change',applyFilters);

    // ===== EVENT LISTENERS PARA ADMINISTRACIÓN =====
    document.getElementById('admin-panel').addEventListener('click', openAdminPanel);
    document.getElementById('close-admin').addEventListener('click', closeAdminPanel);
    
    // Cerrar panel de admin al hacer click fuera
    document.getElementById('admin-modal').addEventListener('click', function(event){
      if(event.target == this){
        closeAdminPanel();
      }
    });

    // ===== FUNCIONALIDAD DEL MODAL DE IMAGEN =====
    function openImageModal(imageSrc, wineName){
      var imageModal = document.getElementById('image-modal');
      var modalImage = document.getElementById('modal-image');
      var modalWineName = document.getElementById('modal-wine-name');
      var modalWineDetails = document.getElementById('modal-wine-details');
      var modalWineDescription = document.getElementById('modal-wine-description');
      
      // Buscar el vino en la lista
      var wine = PRODUCTOS.find(w => w.nombre === wineName);
      
      modalImage.src = imageSrc;
      modalImage.alt = wineName;
      modalWineName.textContent = wineName;
      
      // Mostrar detalles del vino
      if(wine){
        modalWineDetails.innerHTML = `
          <div class="wine-details-grid">
            <div class="wine-detail-item">
              <div class="wine-detail-label">Bodega</div>
              <div class="wine-detail-value">${wine.bodega}</div>
            </div>
            <div class="wine-detail-item">
              <div class="wine-detail-label">Variedad</div>
              <div class="wine-detail-value">${wine.variedad}</div>
            </div>
            <div class="wine-detail-item">
              <div class="wine-detail-label">Contenido</div>
              <div class="wine-detail-value">${wine.ml} ml</div>
            </div>
            <div class="wine-detail-item">
              <div class="wine-detail-label">Precio</div>
              <div class="wine-detail-value">${money(wine.precio)}</div>
            </div>
          </div>
        `;
        
        // Mostrar descripción si existe
        if(wine.descripcion){
          modalWineDescription.innerHTML = `
            <div class="wine-description">
              ${wine.descripcion}
            </div>
          `;
        } else {
          modalWineDescription.innerHTML = `
            <div class="wine-description">
              <p>Un vino excepcional de ${wine.bodega} que representa lo mejor de la tradición vitivinícola argentina. Perfecto para acompañar tus momentos especiales.</p>
              <p><strong>Recomendación:</strong> Ideal para maridar con carnes rojas, pastas y quesos maduros.</p>
            </div>
          `;
        }
        
        // Mostrar ocasiones si existen
        if(wine.ocasiones && wine.ocasiones.length > 0){
          var ocasionesHTML = wine.ocasiones.map(ocasion => `<span class="ocasion-tag">${ocasion}</span>`).join('');
          modalWineDescription.innerHTML += `
            <div class="wine-ocasiones">
              <h4>🍷 Perfecto para:</h4>
              <div class="ocasiones-tags">
                ${ocasionesHTML}
              </div>
            </div>
          `;
        }
      }
      
      imageModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeImageModal(){
      var imageModal = document.getElementById('image-modal');
      imageModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    // Event listeners para modal de imagen
    document.getElementById('close-image').addEventListener('click', closeImageModal);
    document.getElementById('image-modal').addEventListener('click', function(event){
      if(event.target == this){
        closeImageModal();
      }
    });
    
    // Cerrar con tecla Escape
    document.addEventListener('keydown', function(event){
      if(event.key === 'Escape'){
        var imageModal = document.getElementById('image-modal');
        var wineModal = document.getElementById('wine-modal');
        if(imageModal.style.display === 'block'){
          closeImageModal();
        } else if(wineModal.style.display === 'block'){
          closeModal();
        }
      }
    });

    // ===== DETECCIÓN DE ENTORNO LOCAL =====
    function isLocalEnvironment(){
      return window.location.hostname === 'localhost' || 
             window.location.hostname === '127.0.0.1' || 
             window.location.hostname === '0.0.0.0' ||
             window.location.protocol === 'file:';
    }

    // Mostrar botones de administración solo en local
    if(isLocalEnvironment()){
      document.getElementById('admin-panel').style.display = 'inline-block';
      document.getElementById('add-wine').style.display = 'inline-block';
    }

    // ===== FUNCIONALIDAD DEL PANEL DE ADMINISTRACIÓN =====
    function openAdminPanel(){
      var adminModal = document.getElementById('admin-modal');
      adminModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      loadWinesList();
      loadSettings();
    }

    function closeAdminPanel(){
      var adminModal = document.getElementById('admin-modal');
      adminModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function showAdminTab(tabName){
      // Ocultar todos los tabs
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Remover clase active de todos los botones
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Mostrar tab seleccionado
      document.getElementById('admin-' + tabName).style.display = 'block';
      
      // Activar botón correspondiente
      event.target.classList.add('active');
    }

    function loadWinesList(){
      var winesList = document.getElementById('wines-list');
      var html = '';
      
      for(var i = 0; i < PRODUCTOS.length; i++){
        var wine = PRODUCTOS[i];
        html += '<div class="wine-item">' +
          '<img src="' + (wine.foto || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><rect width="60" height="60" fill="%23efe7db"/><text x="30" y="35" text-anchor="middle" font-size="20">🍷</text></svg>') + '" alt="' + wine.nombre + '">' +
          '<div class="wine-info">' +
            '<div class="wine-name">' + wine.nombre + '</div>' +
            '<div class="wine-meta">' + wine.bodega + ' · ' + wine.variedad + ' · ' + wine.ml + ' ml</div>' +
            '<div class="wine-price">' + money(wine.precio) + '</div>' +
          '</div>' +
          '<div class="wine-actions">' +
            '<button class="btn-edit" onclick="editWine(\'' + wine.id + '\')">✏️ Editar</button>' +
            '<button class="btn-delete" onclick="deleteWine(\'' + wine.id + '\')">🗑️ Eliminar</button>' +
          '</div>' +
        '</div>';
      }
      
      winesList.innerHTML = html;
    }

    function loadSettings(){
      document.getElementById('admin-whatsapp').value = WHATSAPP_PHONE;
      document.getElementById('admin-title').value = document.querySelector('h1').textContent;
      document.getElementById('admin-subtitle').value = document.querySelector('.sub').textContent;
    }

    function saveSettings(){
      WHATSAPP_PHONE = document.getElementById('admin-whatsapp').value;
      document.querySelector('h1').textContent = document.getElementById('admin-title').value;
      document.querySelector('.sub').textContent = document.getElementById('admin-subtitle').value;
      
      // Guardar en LocalStorage
      saveConfig();
      
      alert('✅ Configuración guardada en LocalStorage');
    }

    function editWine(wineId){
      var wine = PRODUCTOS.find(w => w.id == wineId);
      if(!wine) return;
      
      // Llenar formulario con datos del vino
      document.getElementById('wine-name').value = wine.nombre;
      document.getElementById('wine-bodega').value = wine.bodega;
      document.getElementById('wine-variedad').value = wine.variedad;
      document.getElementById('wine-ml').value = wine.ml;
      document.getElementById('wine-precio').value = wine.precio;
      document.getElementById('wine-precio-anterior').value = wine.precioAnterior || '';
      document.getElementById('wine-stock').value = wine.stock !== undefined ? wine.stock : 10;
      document.getElementById('wine-foto').value = wine.foto || '';
      
      // Cambiar título del modal
      document.querySelector('#wine-modal .modal-header h2').textContent = '✏️ Editar Vino';
      
      // Abrir modal de vino
      closeAdminPanel();
      document.getElementById('wine-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Guardar ID para actualización (como string para mantener consistencia)
      window.editingWineId = String(wineId);
    }

    function deleteWine(wineId){
      if(confirm('¿Estás seguro de que quieres eliminar este vino?')){
        var index = PRODUCTOS.findIndex(w => w.id == wineId);
        if(index > -1){
          PRODUCTOS.splice(index, 1);
          
          // Guardar en LocalStorage
          saveProductos();
          
          state.rows = PRODUCTOS.slice();
          applyFilters();
          loadWinesList();
          alert('✅ Vino eliminado y guardado');
        }
      }
    }

    function openAddWineModal(){
      // Limpiar formulario
      document.getElementById('wine-form').reset();
      
      // Cambiar título del modal
      document.querySelector('#wine-modal .modal-header h2').textContent = '🍷 Agregar Nuevo Vino';
      
      // Cerrar panel de admin y abrir modal de vino
      closeAdminPanel();
      document.getElementById('wine-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Limpiar ID de edición
      window.editingWineId = null;
    }

    function exportWines(){
      var dataStr = JSON.stringify(PRODUCTOS, null, 2);
      var dataBlob = new Blob([dataStr], {type: 'application/json'});
      var url = URL.createObjectURL(dataBlob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'vinos-backup.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function importWines(){
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e){
        var file = e.target.files[0];
        if(file){
          var reader = new FileReader();
          reader.onload = function(e){
            try{
              var importedWines = JSON.parse(e.target.result);
              if(Array.isArray(importedWines)){
                PRODUCTOS = importedWines;
                
                // Guardar en LocalStorage
                saveProductos();
                
                state.rows = PRODUCTOS.slice();
                applyFilters();
                loadWinesList();
                alert('✅ Vinos importados y guardados correctamente');
              } else {
                alert('❌ Formato de archivo inválido');
              }
            } catch(error){
              alert('❌ Error al importar archivo');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function resetToDefaults(){
      if(confirm('⚠️ ¿Estás seguro de que quieres restaurar los productos originales? Esto eliminará todos los cambios que hayas hecho.')){
        if(!useFirebase){
          alert('ℹ️ Firebase no configurado. Recarga la página para volver a los productos originales.');
          location.reload();
          return;
        }
        
        // Eliminar datos de Firebase
        database.ref('productos').remove().then(function(){
          database.ref('config').remove().then(function(){
            alert('✅ Configuración restaurada. La página se recargará.');
            location.reload();
          });
        }).catch(function(e){
          console.error('❌ Error al restaurar configuración:', e);
          alert('❌ Error al restaurar configuración');
        });
      }
    }

    // ===== FUNCIONALIDAD DEL MODAL =====
    var modal = document.getElementById('wine-modal');
    var addWineBtn = document.getElementById('add-wine');
    var closeBtn = document.getElementsByClassName('close')[0];
    var closeWineBtn = document.getElementById('close-wine-modal');
    var cancelBtn = document.getElementById('cancel-wine');
    var wineForm = document.getElementById('wine-form');

    // Abrir modal
    addWineBtn.addEventListener('click', function(){
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevenir scroll
    });

    // Cerrar modal
    function closeModal(){
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      wineForm.reset(); // Limpiar formulario
      window.editingWineId = null; // Limpiar ID de edición
    }

    closeBtn.addEventListener('click', closeModal);
    closeWineBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // Cerrar al hacer click fuera del modal
    window.addEventListener('click', function(event){
      if(event.target == modal){
        closeModal();
      }
    });

    // Cerrar con tecla Escape
    document.addEventListener('keydown', function(event){
      if(event.key === 'Escape' && modal.style.display === 'block'){
        closeModal();
      }
    });

    // Manejar envío del formulario
    wineForm.addEventListener('submit', function(e){
      e.preventDefault();
      
      // Obtener datos del formulario
      var nombre = document.getElementById('wine-name').value.trim();
      var bodega = document.getElementById('wine-bodega').value.trim();
      var variedad = document.getElementById('wine-variedad').value.trim();
      var ml = parseInt(document.getElementById('wine-ml').value);
      var precio = parseInt(document.getElementById('wine-precio').value);
      var precioAnterior = document.getElementById('wine-precio-anterior').value.trim();
      var stock = parseInt(document.getElementById('wine-stock').value) || 0;
      var foto = document.getElementById('wine-foto').value.trim();

      // Validar campos requeridos
      if(!nombre || !bodega || !variedad || !precio){
        alert('Por favor completa todos los campos obligatorios (*)');
        return;
      }

      // Debug: verificar estado de edición
      console.log('editingWineId:', window.editingWineId);
      console.log('Tipo de editingWineId:', typeof window.editingWineId);
      
      // Verificar si es edición o nuevo vino
      if(window.editingWineId){
        // EDITAR VINO EXISTENTE
        console.log('Intentando editar vino con ID:', window.editingWineId);
        var wineIndex = PRODUCTOS.findIndex(w => w.id == window.editingWineId);
        console.log('Índice encontrado:', wineIndex);
        if(wineIndex > -1){
          var vinoEditado = {
            id: window.editingWineId,
            nombre: nombre,
            bodega: bodega,
            variedad: variedad,
            ml: ml,
            precio: precio,
            foto: foto,
            stock: stock
          };
          
          // Agregar precio anterior solo si tiene valor
          if(precioAnterior && precioAnterior !== ''){
            vinoEditado.precioAnterior = parseInt(precioAnterior);
          }
          
          PRODUCTOS[wineIndex] = vinoEditado;
          
          // Guardar en LocalStorage
          saveProductos();
          
          // Actualizar estado y renderizar
          state.rows = PRODUCTOS.slice();
          applyFilters();
          
          // Cerrar modal
          closeModal();
          
          // Mostrar confirmación
          alert('✅ ¡Vino editado y guardado exitosamente!');
          
          // Limpiar el ID de edición
          window.editingWineId = null;
        } else {
          console.error('No se encontró el vino con ID:', window.editingWineId);
          alert('❌ Error: No se encontró el vino a editar');
          window.editingWineId = null;
        }
      } else {
        // AGREGAR NUEVO VINO
        console.log('Agregando nuevo vino');
        var newId = (PRODUCTOS.length + 1).toString();

        // Crear nuevo vino
        var nuevoVino = {
          id: newId,
          nombre: nombre,
          bodega: bodega,
          variedad: variedad,
          ml: ml,
          precio: precio,
          foto: foto,
          stock: stock
        };
        
        // Agregar precio anterior solo si tiene valor
        if(precioAnterior && precioAnterior !== ''){
          nuevoVino.precioAnterior = parseInt(precioAnterior);
        }

        // Agregar a la lista
        PRODUCTOS.push(nuevoVino);
        
        // Guardar en LocalStorage
        saveProductos();
        
        // Actualizar estado y renderizar
        state.rows = PRODUCTOS.slice();
        applyFilters();
        
        // Cerrar modal
        closeModal();
        
        // Mostrar confirmación
        alert('✅ ¡Vino agregado exitosamente!');
      }
    });

    // =====================
    // RECONSTRUCCIÓN DE CARRITO
    // =====================
    function rebuildCartInterface(){
      // Para cada producto en el carrito, actualizar la interfaz
      for(var productId in state.cart){
        var cantidad = state.cart[productId];
        
        // Actualizar el contador específico
        updateCartDisplay(productId);
        
        // Re-renderizar para actualizar badges
        render();
      }
      
      // Actualizar el carrito principal
      renderCart();
    }

    // =====================
    // VERIFICACIÓN DE STOCK
    // =====================
    function checkStockAndCleanCart(){
      // Verificar cada producto en el carrito
      for(var productId in state.cart){
        var cantidadEnCarrito = state.cart[productId];
        var producto = PRODUCTOS.find(p => p.id == productId);
        
        if(producto && producto.stock !== undefined){
          // Si no hay suficiente stock, ajustar o eliminar del carrito
          if(producto.stock < cantidadEnCarrito){
            if(producto.stock <= 0){
              // Sin stock: eliminar del carrito
              delete state.cart[productId];
            } else {
              // Stock insuficiente: ajustar cantidad
              state.cart[productId] = producto.stock;
            }
          }
        }
      }
      
      // Guardar carrito actualizado en localStorage
      localStorage.setItem('cart', JSON.stringify(state.cart));
      
      // Actualizar el carrito en la interfaz
      renderCart();
    }

    // ===== INICIALIZACIÓN =====
    // Cargar productos y configuración al iniciar
    loadProductos(function(productos){
      PRODUCTOS = productos;
      
      // Sincronizar fotos nuevas del código a Firebase
      if(useFirebase){
        setTimeout(function(){
          saveProductos();
          console.log('✅ Sincronizando fotos con Firebase');
        }, 2000);
      }
      
      state.rows = PRODUCTOS.slice();
      state.filtered = PRODUCTOS.slice();
      
      // RECARGAR CARRITO DESDE LOCALSTORAGE DESPUÉS DE LOADPRODUCTOS
      var savedCart = localStorage.getItem('cart');
      if(savedCart){
        state.cart = JSON.parse(savedCart);
      }
      
      // Renderizar con el carrito recargado
      render();
      
      // Cargar configuración después de renderizar
      loadConfig();
    });

    // =====================
    // PRUEBAS BÁSICAS (console)
    // =====================
    (function runTests(){
      try{
        // Test 1: buildWhatsAppText incluye saltos de línea reales \n
        state.cart = { '1':2, '3':1 };
        var text = buildWhatsAppText();
        console.assert(text.indexOf('\n')>-1, '[TEST1] Debe contener \n');
        // Test 2: la URL codifica los \n como %0A
        var url = 'https://wa.me/'+WHATSAPP_PHONE+'?text='+encodeURIComponent(text);
        console.assert(url.indexOf('%0A')>-1, '[TEST2] Debe tener %0A');
        // Restablecer estado
        state.cart = {}; renderCart();
        console.log('[OK] Tests mínimos pasaron');
      }catch(e){ console.warn('Tests fallaron', e); }
    })();
  </script>
</body>
</html>
